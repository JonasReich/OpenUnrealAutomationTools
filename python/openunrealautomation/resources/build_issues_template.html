<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>REPORT_TITLE</title>

    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <style>
        #filter-btns {
            display: block;
        }

        .scope-container {
            background-color: #6f6f6f17;
            border: 1px;
            border-color: var(--bs-info);
            color: var(--bs-info);
            border-style: solid;
            margin: 0;
            padding: 0.3em !important;
            margin-top: .2em;
        }

        .scope-success {
            background-color: #36ff0e17;
            border-color: var(--bs-success);
            color: var(--bs-success);
        }

        .scope-failure {
            background-color: #9527271a;
            border-color: var(--bs-danger);
            color: var(--bs-danger);
        }

        .scope-container>div:first-of-type {
            font-size: 0.8em;
            font-variant: small-caps;
            box-shadow: 0 +1px 0 #ffffff2e;
            padding-bottom: 2px;
            margin: -0.3em;
            padding-top: 2px;
            padding-left: 1em;
            padding-right: 0;
            width: calc(110% + 1.3em);
            right: 0;
            left: 0;
            position: relative;
            min-width: calc(100% + .6em);
            background: #ffffff12;
        }

        .highlight-line {
            margin-top: -100px;
            position: relative;
            display: inline;
            padding-top: 100px;
            z-index: +1;
        }

        .highlight-line::after {
            content: "";
            background-color: #b4b4f2;
            position: relative;
            top: 0.3em;
            /*Arbitrary large number that hopefully fits an entire line. Anchoring on the left side would be preferred.*/
            width: 20000px;
            height: 1.5em;
            display: inline-block;
            bottom: 0;
            right: 0;
            left: -20000px;
            z-index: -1;
        }

        .code-container {
            overflow: scroll;
            max-height: 600px;
            max-width: 98%;
            background-color: #1c1c1c;
        }

        .warning {
            color: rgb(233, 233, 15);
        }

        .severe-warning {
            color: #e9a00f;
        }

        .error {
            color: rgb(225, 21, 21);
        }

        .message {
            color: white;
        }

        #stats-chart-root canvas {
            max-width: 800px;
            max-height: 400px;
        }

        .code-tag {
            display: inline-block;
            color: #737373;
            padding-right: 5px;
        }

        a.file-path {
            cursor: pointer;
            /* Do not underline */
            text-decoration: none;
        }

        .warning .file-path {
            color: rgb(142, 142, 58);
        }

        .error .file-path {
            color: rgb(151, 62, 58);
        }

        .message .file-path {
            color: rgb(138, 138, 138);
        }

        .box-ouu {
            position: relative;
            padding: 1rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: .25rem;
            background-color: #25262bba;
            color: inherit;
            border-color: #f0f8ff24;
        }
    </style>
</head>

<body class="bg-dark text-light">
    <!-- Background -->
    <div
        style="position: fixed;width: 100%;height: 100%;background-image: url(&quot;BACKGROUND_IMAGE_URI&quot;);left: 0;top: 0;z-index: -1;background-color: #393c4f;background-blend-mode: multiply;background-size: cover;filter: blur(4px);">
    </div>
    <!-- Content container -->
    <div class="container-fluid w-100 p-3">
        <div class="row">
            <div class="col-12 pb-3">
                <h2>REPORT_TITLE</h2>
            </div>
            <div class="col-12 col-xxl-8">
                <div class="col-12 box-ouu">
                    <h5>Filtered Log Messages</h5>
                    <!-- anchor for filter button hotbar -->
                    <div class="justify-content-start btn-group btn-group-sm p-2 box-ouu" role="group" id="filter-btns">
                        <button class="btn btn-sm btn-primary filter-btn string-filter-btn" id="show-all-btn">üëÅ Show
                            All</button>
                        <button class="btn btn-sm btn-secondary" id="expand-all-btn"
                            onclick="$('details').attr('open', true)">üîΩ Expand</button>
                        <button class="btn btn-sm btn-secondary" id="collapse-all-btn"
                            onclick="$('details').attr('open', false)">üîº Collapse</button>
                    </div>

                    <!-- anchor for generated text nodes -->
                    <div id="code-root">
                    </div>
                </div>

                INLINE_SOURCE_LOG
            </div>

            <div class="col-12 col-xxl-4">
                <div class="col-12 box-ouu">
                    <h5>Build Stat Graphs</h5>
                    <!-- anchor for stats charts -->
                    <div id="stats-chart-root">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"
        integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src='https://cdn.plot.ly/plotly-2.16.1.min.js'></script>

    <script type="text/javascript">
        // This inline json string will be replaced with the actual json by our Python script that searches for the capitalized variable name
        let inline_json = String.raw`INLINE_JSON`;

        let json_obj = JSON.parse(inline_json);
        console.log(json_obj);

        const zeroPad = (num, places) => String(num).padStart(places, '0');

        var last_goto_lines = new Map();;
        function goToSource(source_file, line) {
            let new_goto_line = `#source-log-${source_file}-${line}`;
            let last_goto_line = last_goto_lines.has(source_file) ? last_goto_lines.get(source_file) : null;
            if (last_goto_line === null) {
                // do nothing
            } else {
                $(last_goto_line).removeClass("highlight-line");
            }
            $(new_goto_line).addClass("highlight-line");
            window.location = new_goto_line;
            // This does not work properly :/
            // $('html,body').animate({ scrollTop: $(new_goto_line).offset().top }, 500);
            last_goto_lines.set(source_file, new_goto_line);
        }

        // #TODO Make this automatic -> Collect item values automatically, so we can just call addButtonsForData("Developer")
        let all_devs = new Set();
        let tag_counts = new Map();

        let chart_colors = [
            "#bb4444",
            "#44bb44",
            "#4444bb",
            "#bbbb44",
            "#44bbbb",
            "#bb44bb"
        ];

        function increment_map_counter(map, key) {
            if (map.has(key)) {
                map.set(key, map.get(key) + 1);
            } else {
                map.set(key, 1);
            }
        }
        function increment_tag_count(tag) {
            increment_map_counter(tag_counts, tag);
        }

        // map variable name to values to counts
        // e.g.
        /*
        {
            "variable_name" : {
                "value_1" : 10,
                "value_2" : 30
            }
        }
        */
        let string_vars = new Map();
        function incrementStringVar(key, value) {
            if (!string_vars.has(key)) {
                string_vars.set(key, new Map());
            }
            let inner_map = string_vars.get(key);
            if (inner_map.has(value)) {
                inner_map.set(value, inner_map.get(value) + 1);
            } else {
                inner_map.set(value, 1);
            }
        }


        function updateSeverityCSS(element, severity) {
            let is_error = severity == "error";
            let is_warning = severity == "warning";
            let is_severe_warning = severity == "severe_warning";
            let is_message = !is_error && !is_warning && !is_severe_warning;

            element.toggleClass("warning", is_warning);
            element.toggleClass("severe-warning", is_severe_warning);
            element.toggleClass("error", is_error);
            element.toggleClass("message", is_message);
        }


        function addLineDiv(line_obj, source_file, line_name = "") {
            let line_string_vars = line_obj.strings;

            for (string_key in line_string_vars) {
                incrementStringVar(string_key, line_string_vars[string_key]);
            }

            let tagged_dev = line_string_vars["Developer"] ?? "";
            all_devs.add(tagged_dev);

            let dev_str = tagged_dev == "" ? "" : `by ${tagged_dev} &emsp;&emsp;`;
            let line_str = line_obj.line;
            let file_path_matches = line_str.match(/([\\\/\w\.]+:?[\/\\][\\\/\w\.]+)/g, "");
            if (file_path_matches) {
                for (let i = 0; i < file_path_matches.length; i++) {
                    let file_path = file_path_matches[i];
                    line_str = line_str.replace(file_path, `<a onclick="navigator.clipboard.writeText('${file_path.replace("\\", "\\\\")}')" class="file-path code-tag">${file_path}</a>`);
                }
            }

            let jump_to_src_btn = `<button class="btn-xs btn-secondary" style="font-size: 0.6em; margin-right: 1em;" onclick="goToSource('${source_file}', ${line_obj.line_nr})">üîó</button>`
            let new_code_line = $(`${line_name} <code>${jump_to_src_btn}<div class="code-tag">${dev_str}${zeroPad(line_obj.occurences)}x (1st at line ${zeroPad(line_obj.line_nr, 5)}): </div>${line_str}<br></code>`);
            new_code_line.data("json", line_obj);
            new_code_line.data("source_file", source_file);

            for (tag_idx in line_obj.tags) {
                increment_tag_count(line_obj.tags[tag_idx]);
            }

            updateSeverityCSS(new_code_line, line_obj.severity);

            return new_code_line;
        }

        let CODE_CONTAINER_TEMPLATE = `<div class="text-nowrap overflow-scroll mx-3 p-3 code-container"><div>`;

        function addMatchListCodeContainer(match_list, parent) {
            match_list_row = $(`<details class="row issue-scope pt-2"><summary>${name}</summary>${CODE_CONTAINER_TEMPLATE}</details>`);
            match_list_row.data("name", name);
            parent.append(match_list_row);
            match_list_row.data("json", match_list);

            updateSeverityCSS(match_list_row, match_list.severity);

            return match_list_row.find(".code-container");
        }


        function addIssueScope(source_file, scope, ref_node) {
            // #TODO adjust css classes
            let scope_row = $(`<div class="row scope-container scope-${scope.status} pt-2 px-4"><div>${scope.name}</div></div>`);
            $(ref_node).append(scope_row);

            if ((typeof scope.start === 'string' || scope.start instanceof String) == false && scope.start.severity != "message") {
                let start_code_line = addLineDiv(scope.start, source_file, "Start");
                scope_row.append($(CODE_CONTAINER_TEMPLATE).append(start_code_line));
            }

            scope.match_lists.forEach(match_list => {
                let code_container = addMatchListCodeContainer(match_list, scope_row);

                for (let line_idx = 0; line_idx < match_list.lines.length; line_idx++) {
                    let line_obj = match_list.lines[line_idx];
                    let new_code_line = addLineDiv(line_obj, source_file);
                    code_container.append(new_code_line);
                }
            });

            scope.child_scopes.forEach(child_scope => {
                addIssueScope(source_file, child_scope, scope_row);
            });

            if ((typeof scope.end === 'string' || scope.end instanceof String) == false && scope.end.severity != "message") {
                let end_code_line = addLineDiv(scope.end, source_file, "End");
                scope_row.append($(CODE_CONTAINER_TEMPLATE).append(end_code_line));
            }
        }

        for (const [source_file, scope] of Object.entries(json_obj)) {
            addIssueScope(source_file, scope, $("#code-root")[0]);
        }

        let tags_and_labels = FILTER_TAGS_AND_LABELS;
        function getTagLabel(tag) {
            return tags_and_labels[tag] ?? tag;
        }

        function updateScopeCounters() {
            $(".issue-scope").each(function () {
                num_children = 0;
                num_active_children = 0;
                $(this).find("code").each(function () {
                    num_children++;
                    if ($(this).css("display") != "none")
                        num_active_children++;
                })

                summary = $(this).find("summary");
                json_data = $(this).data("json");

                let tag_label_str = "";
                let first_label = true;
                for (let tag_idx = 0; tag_idx < json_data.tags.length; tag_idx++) {
                    let tag = json_data.tags[tag_idx];
                    if (!first_label)
                        tag_label_str += ", ";
                    first_label = false;
                    tag_label_str += getTagLabel(tag);
                }

                summary.text(json_data.name + ` (${num_active_children}/${num_children})`);
                $(this).toggle(num_active_children > 0);
            })
        }
        updateScopeCounters();

        var filter = {
            tags: new Set(),
            strings: new Map()
        };

        function resetFilter() {
            filter.tags.clear();
            filter.strings.clear();

            $("#code-root code").show();
            // Reset all filter buttons
            $(".filter-btn").toggleClass("btn-primary", false);
            $(".filter-btn").toggleClass("btn-secondary", true);
        }

        function applyFilter() {
            $("#code-root code").each(function () {
                let tags = $(this).data("json")["tags"];
                let has_all_tags = true;
                for (const filter_tag of filter.tags.keys()) {
                    if (tags.includes(filter_tag) == false) {
                        has_all_tags = false;
                    }
                }
                if (!has_all_tags) {
                    $(this).toggle(false);
                    return;
                }
                let has_all_strings = true;
                for (const [string_var, string_value] of filter.strings.entries()) {
                    let item_string_value = $(this).data("json").strings[string_var];
                    if (item_string_value != string_value) {
                        has_all_strings = false;
                    }
                }
                $(this).toggle(has_all_strings);
            });

            updateScopeCounters();
        }

        let show_all_button = $("#show-all-btn");
        $(show_all_button).click(function () {
            resetFilter();

            // Set show all button to primary (blue)
            $("#show-all-btn").toggleClass("btn-primary", true);
            $("#show-all-btn").toggleClass("btn-secondary", false);

            updateScopeCounters();
        })
        $("#filter-btns").append(show_all_button);

        $("#filter-btns").append($("<div class='m-2'/>"));

        function filterTags(tag) {
            let filter_now = filter.tags.has(tag) == false;
            if (filter_now) {
                filter.tags.add(tag);
            } else {
                filter.tags.delete(tag);
            }

            $("#show-all-btn").toggleClass("btn-primary", false);
            $("#show-all-btn").toggleClass("btn-secondary", true);

            $(".tag-btn").each(function () {
                let btn_tag = $(this).data("tag");
                if (btn_tag == tag) {
                    $(this).toggleClass("btn-primary", filter_now);
                    $(this).toggleClass("btn-secondary", !filter_now);
                }
            });
            applyFilter();
        }

        // Add buttons
        // #TODO this is hardcoded -> need to make dynamic but still have all POSSIBLE tags
        for (let [tag, label] of Object.entries(tags_and_labels)) {
            let tag_count = tag_counts.has(tag) ? tag_counts.get(tag) : 0;
            let tag_button = $(`<button class="btn btn-sm btn-secondary filter-btn tag-btn">${getTagLabel(tag)} (${tag_count})</button>`);
            tag_button.data("tag", tag);
            $(tag_button).click(function () { filterTags(tag) });
            $("#filter-btns").append(tag_button);
        }

        $("#filter-btns").append($("<div class='m-2'/>"));

        function addFilterButtonForStringVar(string_var, css_label, button_prefix, string_var_items) {
            function filterStringData(item_value) {
                let filter_now = true;
                if (filter.strings.has(string_var)) {
                    if (filter.strings.get(string_var) == item_value) {
                        filter.strings.delete(string_var);
                        filter_now = false;
                    }
                }
                if (filter_now) {
                    filter.strings.set(string_var, item_value);
                }

                $("#show-all-btn").toggleClass("btn-primary", false);
                $("#show-all-btn").toggleClass("btn-secondary", true);

                $(".string-filter-btn").each(function () {
                    let item = $(this).data(string_var);
                    if (item == item_value) {
                        $(this).toggleClass("btn-primary", filter_now);
                        $(this).toggleClass("btn-secondary", !filter_now);
                    } else {
                        // developer buttons are mutually exclusive
                        $(this).toggleClass("btn-primary", false);
                        $(this).toggleClass("btn-secondary", true);
                    }
                });
                applyFilter();
            }

            string_var_items.forEach(function (item) {
                if (item == "") return;
                let value_count = string_vars.get(string_var).get(item);
                let button = $(`<button class="btn btn-sm btn-secondary filter-btn string-filter-btn">${button_prefix} ${item} (${value_count})</button>`);
                button.data(string_var, item);
                $(button).click(function () { filterStringData(item) });
                $("#filter-btns").append(button);
            })
        }

        addFilterButtonForStringVar("Developer", "dev", "üë§", all_devs);

        //---------------------------
        // STATS

        // Craete a chart canvas context
        function createChartContext() {
            let canvasRoot = $("#stats-chart-root")[0];
            var canvasTemplate = '<canvas id="stats-chart" class="p-2 m-3 bg-dark"></canvas>';
            let canvas = $(canvasTemplate).appendTo(canvasRoot)[0];
            $(canvas).css("display", "inline-block");
            return canvas.getContext('2d');
        }

        function createIssuesPerTagChart() {
            let labels = [];
            let error_counts = [];
            let warning_counts = [];
            let severe_warning_counts = [];
            let message_counts = [];

            let error_counts_total = [];
            let warning_counts_total = [];
            let severe_warning_counts_total = [];
            let message_counts_total = [];

            // #TODO instead of counting occurences manually, the json export should contain tag data incl. unique tag occurences + total tag occurences
            tag_counts.forEach(function (count, tag) {
                labels.push(getTagLabel(tag));
                let error_count = 0;
                let warning_count = 0;
                let severe_warning_count = 0;
                let message_count = 0;
                let error_count_total = 0;
                let warning_count_total = 0;
                let severe_warning_count_total = 0;
                let message_count_total = 0;
                count = $("#code-root code").each(function () {
                    if ($(this).data("json").tags.includes(tag) == false) {
                        return;
                    }
                    if ($(this).data("json").severity == "error") {
                        error_count++;
                        error_count_total += $(this).data("json").occurences;
                    } else if ($(this).data("json").severity == "warning") {
                        warning_count++;
                        warning_count_total += $(this).data("json").occurences;
                    } else if ($(this).data("json").severity == "severe_warning") {
                        severe_warning_count++;
                        severe_warning_count_total += $(this).data("json").occurences;
                    } else {
                        message_count++;
                        message_count_total += $(this).data("json").occurences;
                    }
                })
                error_counts.push(error_count);
                warning_counts.push(warning_count);
                severe_warning_counts.push(severe_warning_count);
                message_counts.push(message_count);
                error_counts_total.push(error_count_total);
                warning_counts_total.push(warning_count_total);
                severe_warning_counts_total.push(severe_warning_count_total);
                message_counts_total.push(message_count_total);
            })

            function createIssueCountChart(title, error_counts_var, warning_counts_var, severe_warning_counts_var, message_counts_var) {
                new Chart(createChartContext(), {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [
                            { label: "Errors", data: error_counts_var, backgroundColor: "#bb4444", color: "#bb4444" },
                            { label: "Warnigns", data: warning_counts_var, backgroundColor: "#bbbb44", color: "#bbbb44" },
                            { label: "Severe Warnigns", data: severe_warning_counts_var, backgroundColor: "#e9a00f", color: "#e9a00f" },
                            { label: "Messages", data: message_counts_var, backgroundColor: "#aaaaaa", color: "#aaaaaa" }
                        ]
                    },
                    options: {
                        color: "white",
                        backgroundColor: "transparent",
                        plugins: {
                            title: { display: true, text: title }
                        }
                    }
                });
            }

            createIssueCountChart("Issues per Tag (Unique)", error_counts, warning_counts, severe_warning_counts, message_counts);
            createIssueCountChart("Issues per Tag (Total)", error_counts_total, warning_counts_total, severe_warning_counts_total, message_counts_total);
        }
        createIssuesPerTagChart()

        const ChartPreset = {
            BAR: "bar",
            BAR_HORIZONTAL: "barh",
            LINE: "line",
            PIE: "pie"
        };

        // Create a dynamic chart based on numerics data
        // item_key_variable is the string variable name to use as label for data points
        // stats are the individual numerics -> 1 data set per stat
        // lables are display names for the data sets
        function createNumericsChart(preset, chart_title, item_key_variable, stats, labels) {
            let datamap = new Map();
            let datasets = [];
            let item_labels = [];

            for (let i = 0; i < stats.length; i++) {
                const stat = stats[i];
                let data = [];
                let code_idx = 0;
                $("#code-root code").each(function (index, element) {
                    const json = $(this).data("json");
                    let datapoint_key = json.strings[item_key_variable];
                    if (datapoint_key === undefined) {
                        return;
                    }

                    const data_point = json.numerics[stat];
                    item_labels.length = Math.max(item_labels.length, code_idx + 1);
                    item_labels[code_idx] = datapoint_key;
                    data.push(data_point);
                    code_idx++;
                })
                const color = preset == ChartPreset.PIE ? chart_colors : chart_colors[i];
                const label = labels[i];
                datasets.push({
                    label: label,
                    data: data,
                    backgroundColor: color,
                    color: color,
                    borderColor: color,
                    //borderWidth: 1
                });
            }

            let type = "bar";
            switch (preset) {
                case ChartPreset.BAR:
                case ChartPreset.BAR_HORIZONTAL:
                    type = "bar"
                    break
                case ChartPreset.LINE:
                    type = "line"
                    break
                case ChartPreset.PIE:
                    type = "pie"
                    break
            }
            let indexAxis = (preset == ChartPreset.BAR_HORIZONTAL ? 'y' : 'x');

            new Chart(createChartContext(), {
                type: type,
                data: {
                    labels: Array.from(item_labels),
                    datasets: datasets
                },
                options: {
                    color: "white",
                    backgroundColor: "transparent",
                    indexAxis: indexAxis,
                    plugins: {
                        title: {
                            display: true,
                            text: chart_title
                        }
                    }
                }
            });
        }
        let ddc_stats = ["DDC_TotalTime", "DDC_GameThreadTime", "DDC_AssetNum", "DDC_MB"];
        let ddc_labels = ["Total Time", "Game Thread Time", "Asset Number", "MB"];
        createNumericsChart(ChartPreset.LINE, "DDC Resource Stats", "DDC_Key", ddc_stats, ddc_labels);

        createNumericsChart(ChartPreset.PIE, "UAT Command Times", "UAT_Command", ["Duration"], ["Duration"]);
        // No good way to display exit codes in a chart
        // createNumericsChart(ChartPreset.LINE_HORIZONTAL, "UAT Commands", "UAT_Command", ["ExitCode"], ["ExitCode"])
    </script>

    <!-- Script Inject from Python generator -->
    <script type="text/javascript">
        INLINE_JAVASCRIPT
    </script>

</body>

</html>